<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç›´æ’­åŠ©æ‰‹è¯æœ¯åº“ 2.0 - ä¼˜åŒ–ç‰ˆ</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }
    
    .header h1 {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    /* é€šç”¨å¡ç‰‡æ ·å¼ */
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    

    
    /* æ§åˆ¶é¢æ¿ */
    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    /* æŒ‰é’®æ ·å¼ */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid #6366f1;
      color: #6366f1;
    }
    
    .btn-outline:hover:not(:disabled) {
      background: #6366f1;
      color: white;
    }
    
    /* è¿‡æ»¤å™¨ */
    .filter-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .filter-btn {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .filter-btn.active {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }
    
    .refresh-btn {
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .refresh-btn:hover:not(:disabled) {
      background: #e5e7eb;
      transform: rotate(180deg);
    }
    
    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .refresh-btn.loading {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* è¯æœ¯åˆ—è¡¨ */
    .scripts-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .script-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      border-left: 4px solid #6366f1;
      width: 100%;
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }
    
    .script-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }
    
    /* åˆ†ç±»é¢œè‰² */
    .script-card.welcome { border-left-color: #10b981; }
    .script-card.interaction { border-left-color: #06b6d4; }
    .script-card.lottery { border-left-color: #f59e0b; }
    .script-card.promotion { border-left-color: #ef4444; }
    .script-card.question { border-left-color: #8b5cf6; }
    
    .script-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    
    .script-title {
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    
    .script-content {
      color: #4b5563;
      line-height: 1.5;
      white-space: pre-wrap;
      margin-bottom: 0;
    }
    
    .copy-btn {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .copy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }
    
    /* AIé¢æ¿ */
    .ai-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .ai-panel-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .ai-panel-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .ai-panel-header h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .panel-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .panel-section:last-child {
      border-bottom: none;
    }
    
    .panel-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }
    
    .panel-section textarea,
    .panel-section input {
      width: 100%;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 15px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    .panel-section textarea:focus,
    .panel-section input:focus {
      outline: none;
      border-color: #6366f1;
    }
    
    .config-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .config-row:last-child {
      margin-bottom: 0;
    }
    
    .prompt-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .prompt-tab {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .prompt-tab.active {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }
    
    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: #ef4444;
    }
    
    .history-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .history-item:hover {
      background: #f3f4f6;
      border-color: #6366f1;
    }
    
    .history-item-date {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 5px;
    }
    
    .history-item-preview {
      color: #374151;
      font-size: 0.95rem;
    }
    
    .no-history {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 20px;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header {
        margin-bottom: 20px;
      }
      
      .header h1 {
        font-size: 1.8rem;
      }
      
      .card {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .script-card {
        padding: 12px;
        margin-bottom: 10px;
      }
      
      .script-title {
        font-size: 0.9rem;
      }
      
      .script-content {
        font-size: 0.9rem;
        line-height: 1.4;
      }
      
      .copy-btn {
        padding: 4px 8px;
        font-size: 0.75rem;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      
      .filter-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        justify-items: stretch;
      }
      
      .filter-buttons .filter-btn[data-category="all"] {
        grid-column: 1 / -1;
        justify-self: center;
        max-width: 200px;
      }
      
      .filter-group {
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(99, 102, 241, 0.05);
        padding: 4px;
        border-radius: 12px;
        border: 1px solid rgba(99, 102, 241, 0.1);
      }
      
      .filter-group .filter-btn {
        flex: 1;
        padding: 6px 8px;
        font-size: 0.8rem;
        border-radius: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .filter-group .refresh-btn {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
        flex-shrink: 0;
      }
      
      .config-row {
        grid-template-columns: 1fr;
      }
      
      .scripts-grid {
        gap: 12px;
      }
      
      .script-card {
        padding: 16px;
        border-radius: 10px;
      }
    }
    
    /* è¶…å°å±å¹•ä¼˜åŒ– */
    @media (max-width: 480px) {
      .filter-buttons {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      
      .filter-group .filter-btn {
        font-size: 0.75rem;
        padding: 5px 6px;
      }
      
      .filter-group {
        padding: 3px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸ¯ ç›´æ’­åŠ©æ‰‹è¯æœ¯åº“ 2.0</h1>
      <p>AIæ™ºèƒ½ç”Ÿæˆï¼Œè®©ä½ çš„ç›´æ’­æ›´ç²¾å½©</p>
    </div>



    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="card controls">
      <div class="filter-buttons">
        <button class="filter-btn active" data-category="all">ğŸŒŸ å…¨éƒ¨</button>
        <div class="filter-group">
          <button class="filter-btn" data-category="interaction">ğŸ’¬ è¯„è®ºåŒºäº’åŠ¨</button>
          <button class="refresh-btn" data-category="interaction" onclick="refreshCategory('interaction')" title="åˆ·æ–°è¯„è®ºåŒºäº’åŠ¨è¯æœ¯">ğŸ”„</button>
        </div>
        <div class="filter-group">
          <button class="filter-btn" data-category="lottery">ğŸ æŠ½å¥–è¯æœ¯</button>
          <button class="refresh-btn" data-category="lottery" onclick="refreshCategory('lottery')" title="åˆ·æ–°æŠ½å¥–è¯æœ¯">ğŸ”„</button>
        </div>
        <div class="filter-group">
          <button class="filter-btn" data-category="question">â“ äº’åŠ¨é—®é¢˜</button>
          <button class="refresh-btn" data-category="question" onclick="refreshCategory('question')" title="åˆ·æ–°äº’åŠ¨é—®é¢˜">ğŸ”„</button>
        </div>
        <div class="filter-group">
          <button class="filter-btn" data-category="promotion">ğŸ“¢ æœ‹å‹åœˆè½¬å‘</button>
          <button class="refresh-btn" data-category="promotion" onclick="refreshCategory('promotion')" title="åˆ·æ–°æœ‹å‹åœˆè½¬å‘è¯æœ¯">ğŸ”„</button>
        </div>
      </div>
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <button class="btn btn-outline" onclick="clearAllScripts()">ğŸ—‘ï¸ æ¸…ç©ºè¯æœ¯</button>
        <button class="btn btn-primary" onclick="toggleAIPanel()">ğŸ¤– AIåˆ†æ</button>
      </div>
    </div>

    <!-- è¯æœ¯å±•ç¤ºåŒºåŸŸ -->
    <div class="scripts-grid" id="scriptsGrid">
      <p style="text-align: center; color: #666; margin: 50px 0;">æš‚æ— è¯æœ¯å†…å®¹ï¼Œè¯·ä½¿ç”¨AIåˆ†æåŠŸèƒ½ç”Ÿæˆè¯æœ¯</p>
    </div>

    <!-- äº’åŠ¨é—®é¢˜åº“ -->
    <div class="scripts-grid" id="questionsGrid">
      <p style="text-align: center; color: #666; margin: 50px 0;">æš‚æ— é—®é¢˜å†…å®¹ï¼Œè¯·ä½¿ç”¨AIåˆ†æåŠŸèƒ½ç”Ÿæˆé—®é¢˜</p>
    </div>
  </div>

  <!-- AIåˆ†æé¢æ¿ -->
  <div class="ai-panel" id="aiPanel" style="display: none;">
    <div class="ai-panel-content">
      <div class="ai-panel-header">
        <h3>ğŸ¤– AIæ™ºèƒ½åˆ†æ</h3>
        <button class="close-btn" onclick="toggleAIPanel()">Ã—</button>
      </div>
      
      <!-- ç›´æ’­ç¨¿è¾“å…¥ -->
      <div class="panel-section">
        <label for="liveScript">ğŸ“ ç›´æ’­ç¨¿å†…å®¹</label>
        <textarea id="liveScript" rows="8" placeholder="è¯·ç²˜è´´ä½ çš„ç›´æ’­ç¨¿å†…å®¹ï¼ŒAIå°†åŸºäºæ­¤å†…å®¹ç”Ÿæˆç›¸åº”çš„è¯æœ¯..."></textarea>
      </div>
      
      <!-- APIé…ç½® -->
      <div class="panel-section">
        <h4 style="margin-bottom: 15px;">âš™ï¸ APIé…ç½®</h4>
        <div class="config-row">
          <div>
            <label for="apiUrl">APIåœ°å€</label>
            <input type="text" id="apiUrl" placeholder="https://aihubmix.com/v1/chat/completions" value="https://aihubmix.com/v1/chat/completions">
          </div>
          <div>
            <label for="modelName">æ¨¡å‹åç§°</label>
            <select id="modelSelect" onchange="handleModelSelect()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
              <option value="DeepSeek-R1">DeepSeek-R1</option>
              <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview-05-20</option>
              <option value="gemini-2.5-pro-preview-06-05">gemini-2.5-pro-preview-06-05</option>
              <option value="custom">æ‰‹åŠ¨å¡«å†™</option>
            </select>
            <input type="text" id="modelName" placeholder="é€‰æ‹©æ¨¡å‹æˆ–æ‰‹åŠ¨è¾“å…¥" value="DeepSeek-R1" style="display: none;">
          </div>
        </div>
        <div class="config-row">
          <div style="grid-column: 1 / -1;">
            <label for="apiKey">APIå¯†é’¥</label>
            <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥ä½ çš„APIå¯†é’¥">
          </div>
        </div>
        <button class="btn btn-success" onclick="saveConfig()" style="margin-top: 10px;">ğŸ’¾ ä¿å­˜é…ç½®</button>
      </div>
      
      <!-- æç¤ºè¯è‡ªå®šä¹‰ -->
      <div class="panel-section">
        <h4 style="margin-bottom: 15px;">âœï¸ æç¤ºè¯è‡ªå®šä¹‰</h4>
        <div class="prompt-tabs">
          <button class="prompt-tab active" onclick="switchPromptTab('interaction')">ğŸ’¬ äº’åŠ¨è¯æœ¯</button>
          <button class="prompt-tab" onclick="switchPromptTab('lottery')">ğŸ æŠ½å¥–è¯æœ¯</button>
          <button class="prompt-tab" onclick="switchPromptTab('question')">â“ äº’åŠ¨é—®é¢˜</button>
          <button class="prompt-tab" onclick="switchPromptTab('promotion')">ğŸ“¢ æ¨å¹¿è¯æœ¯</button>
        </div>
        <textarea id="currentPrompt" rows="6" placeholder="è‡ªå®šä¹‰æç¤ºè¯..."></textarea>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button class="btn btn-success" onclick="savePrompt()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
          <button class="btn btn-outline" onclick="resetPrompt()">ğŸ”„ é‡ç½®é»˜è®¤</button>
        </div>
      </div>
      
      <!-- åˆ†ææŒ‰é’® -->
      <div class="panel-section">
        <button class="btn btn-primary" onclick="analyzeScript()" id="analyzeBtn" style="width: 100%; font-size: 1.1rem; padding: 15px;">
          <span class="btn-text">ğŸš€ å¼€å§‹AIåˆ†æ</span>
          <div class="loading-spinner"></div>
        </button>
        
        <!-- è¿›åº¦æ¡ -->
        <div id="progressContainer" style="display: none; margin-top: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span id="progressText">æ­£åœ¨åˆ†æ...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div style="width: 100%; height: 8px; background-color: #f0f0f0; border-radius: 4px; overflow: hidden;">
            <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s ease;"></div>
          </div>
          <div id="progressDetails" style="margin-top: 8px; font-size: 0.9em; color: #666;"></div>
          <button class="btn btn-outline" onclick="returnToHome()" id="returnBtn" style="margin-top: 10px; width: 100%; display: none;">
            ğŸ“± è¿”å›ä¸»é¡µï¼ˆåå°ç»§ç»­ç”Ÿæˆï¼‰
          </button>
        </div>
      </div>
      
      <!-- å†å²è®°å½• -->
      <div class="panel-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4>ğŸ“š åˆ†æå†å²</h4>
          <button class="btn btn-outline" onclick="clearHistory()" style="padding: 6px 12px; font-size: 0.9rem;">æ¸…ç©ºå†å²</button>
        </div>
        <div id="historyList" style="max-height: 200px; overflow-y: auto;">
          <p class="no-history">æš‚æ— åˆ†æå†å²</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // é…ç½®å¸¸é‡
    const CONFIG = {
      CATEGORIES: {
        interaction: { name: 'ğŸ’¬ äº’åŠ¨è¯æœ¯', color: '#06b6d4' },
        lottery: { name: 'ğŸ æŠ½å¥–è¯æœ¯', color: '#f59e0b' },
        question: { name: 'â“ äº’åŠ¨é—®é¢˜', color: '#8b5cf6' },
        promotion: { name: 'ğŸ“¢ æ¨å¹¿è¯æœ¯', color: '#ef4444' }
      },
      STORAGE_KEYS: {
        AI_CONFIG: 'aiConfig',
        CUSTOM_PROMPTS: 'customPrompts',
        ANALYSIS_HISTORY: 'analysisHistory',
        CONVERSATIONS: 'live_assistant_conversations',
        GENERATED_SCRIPTS: 'liveAssistant_generatedScripts'
      },
      DEFAULT_PROMPTS: {
        interaction: 'ä½ æ˜¯æ‹¥æœ‰20å¹´ç›´æ’­ç»éªŒçš„èµ„æ·±åŠ©æ‰‹ï¼Œè¯·ä»”ç»†é˜…è¯»ç›´æ’­ç¨¿å†…å®¹ï¼Œæ·±å…¥ç†è§£äº§å“ç‰¹ç‚¹å’Œå®¶é•¿éœ€æ±‚ï¼Œç”Ÿæˆ15æ¡è¯„è®ºåŒºäº’åŠ¨è¯æœ¯ã€‚\n\nè¦æ±‚ï¼š\n1. åŒ…å«æ¬¢è¿äº’åŠ¨ã€æ´»åŠ¨äº®ç‚¹ã€äº§å“ä¿ƒé”€ä¸‰ä¸ªç»´åº¦\n2. è¯­è¨€äº²åˆ‡è‡ªç„¶ï¼Œç¬¦åˆç›´æ’­æ°›å›´\n3. èƒ½å¤Ÿæœ‰æ•ˆå¼•å¯¼è§‚ä¼—å‚ä¸å’Œè½¬åŒ–\n4. æ¯æ¡è¯æœ¯æ§åˆ¶åœ¨50å­—ä»¥å†…ï¼Œä¾¿äºå¿«é€Ÿè½®æ’­\n5. æ¯æ¡è¯æœ¯ç‹¬ç«‹æˆè¡Œï¼Œæ ¼å¼ä¸º"1. è¯æœ¯å†…å®¹"\n\nç›´æ’­ç¨¿å†…å®¹ï¼š{content}',
        lottery: 'ä½ æ˜¯ç»éªŒä¸°å¯Œçš„ç›´æ’­åŠ©æ‰‹ï¼Œè¯·è¯†åˆ«å’Œæå–ç›´æ’­ç¨¿é‡Œé¢çš„æŠ½å¥–è¯æœ¯ï¼Œæ–¹ä¾¿æˆ‘å¤åˆ¶ç²˜è´´ã€‚\n\nè¦æ±‚ï¼š\n1. å­—æ•°æ§åˆ¶åœ¨40å­—ä»¥å†…\n2. æ¯æ¡è¯æœ¯ç‹¬ç«‹æˆè¡Œï¼Œæ ¼å¼ä¸º"1. è¯æœ¯å†…å®¹"\n\nç›´æ’­ç¨¿å†…å®¹ï¼š{content}',
        question: 'æˆ‘ç°åœ¨æ˜¯ç›´æ’­é—´çš„æ°´å†›ï¼Œæˆ‘å¸Œæœ›ä»å®¶é•¿çš„è§’åº¦å’Œä¸»æ’­äº’åŠ¨ï¼Œè¯·ä½ å›´ç»•ç€ç›´æ’­ç¨¿ï¼Œå¸®æˆ‘æƒ³50ä¸ªäº’åŠ¨é—®é¢˜ï¼Œå›´ç»•å®¶é•¿æ„Ÿå…´è¶£å’Œå…³å¿ƒçš„è§’åº¦\n\nè¦æ±‚ï¼š\n1. é—®é¢˜è¦çœŸå®è‡ªç„¶ï¼Œç¬¦åˆå®¶é•¿çš„è¡¨è¾¾ä¹ æƒ¯\n2. æ¶µç›–äº§å“å’¨è¯¢ã€ä½¿ç”¨ç–‘é—®ã€æ•ˆæœå…³æ³¨ç­‰ç»´åº¦\n3. æ¯ä¸ªé—®é¢˜ç‹¬ç«‹æˆè¡Œï¼Œæ ¼å¼ä¸º"1. é—®é¢˜å†…å®¹"\n\nç›´æ’­ç¨¿å†…å®¹ï¼š{content}',
        promotion: 'å‚è€ƒä»¥ä¸‹è¯æœ¯ç»“æ„ï¼Œæ ¹æ®ç›´æ’­å†…å®¹ç”Ÿæˆ10æ¡æœ‹å‹åœˆè½¬å‘è¯æœ¯ï¼š\n\nå‚è€ƒè¯æœ¯ï¼š\n"æ¯ä¸ªå­©å­éƒ½æ˜¯æ˜Ÿæ˜Ÿï¼Œåªæ˜¯é—ªè€€çš„æ–¹å¼ä¸åŒâœ¨\nå¤©èµ‹æ½œèƒ½æµ‹è¯„ â€”â€”5 åˆ†é’Ÿè§£é”å­©å­è„‘åŒºä¼˜åŠ¿ã€å­¦ä¹ ç±»å‹ï¼\nä¸­ç§‘é™¢è®¤è¯æŠ€æœ¯ï¼Œä¸ç”¨å¡«é—®å·ã€æ— è¾å°„ï¼Œ3 å² + å°±èƒ½æµ‹ï½\nç›´æ’­é—´é™æ—¶ 168 å…ƒï¼ˆç«‹å‡ 230 å…ƒï¼‰æˆ³é“¾æ¥æŠ¢ğŸ‘‡"\n\nè¦æ±‚ï¼š\n1. ä¿æŒæ¸©é¦¨æ„Ÿäººçš„å¼€å¤´ï¼Œå¸å¼•å®¶é•¿å…±é¸£\n2. çªå‡ºäº§å“æ ¸å¿ƒä»·å€¼å’Œæƒå¨æ€§\n3. å¼ºè°ƒä¼˜æƒ ä¿¡æ¯å’Œç´§è¿«æ„Ÿ\n4. è¯­è¨€ç”ŸåŠ¨æœ‰è¶£ï¼Œé€‚åˆæœ‹å‹åœˆä¼ æ’­\n5. æ¯æ¡è¯æœ¯ç‹¬ç«‹æˆè¡Œï¼Œæ ¼å¼ä¸º"1. è¯æœ¯å†…å®¹"\n\nç›´æ’­ç¨¿å†…å®¹ï¼š{content}'
      }
    };

    // å…¨å±€å˜é‡
    let analysisHistory = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.ANALYSIS_HISTORY) || '[]');
    let currentPromptType = 'interaction';

    // å·¥å…·å‡½æ•°
    const utils = {
      // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
      showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      },

      // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
      async copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          this.showToast('è¯æœ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        } catch (err) {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          this.showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        }
      },

      // éªŒè¯APIé…ç½®
      validateConfig() {
        const liveScript = document.getElementById('liveScript').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        
        if (!liveScript) {
          this.showToast('è¯·å…ˆç²˜è´´ç›´æ’­ç¨¿å†…å®¹ï¼', 'error');
          return false;
        }
        
        if (!apiKey) {
          this.showToast('è¯·å…ˆé…ç½®APIå¯†é’¥ï¼', 'error');
          return false;
        }
        
        return true;
      },

      // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
      setButtonLoading(button, loading) {
        if (loading) {
          button.disabled = true;
          button.classList.add('loading');
        } else {
          button.disabled = false;
          button.classList.remove('loading');
        }
      },

      // è·å–åˆ†ç±»åç§°
      getCategoryName(category) {
        return CONFIG.CATEGORIES[category]?.name || category;
      },

      // è§£æAIè¿”å›ç»“æœ
      parseAIResult(result) {
        const lines = result.split('\n').filter(line => line.trim());
        const scripts = [];
        
        lines.forEach(line => {
          const match = line.match(/^\d+[.ã€]\s*(.+)$/);
          if (match) {
            scripts.push(match[1].trim());
          }
        });
        
        return scripts;
      }
    };

    // å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†
    const conversationManager = {
      // å­˜å‚¨æ¯ä¸ªåˆ†ç±»çš„å¯¹è¯å†å²
      conversations: {
        interaction: [],
        lottery: [],
        question: [],
        promotion: []
      },
      
      // åˆå§‹åŒ–ï¼šä»æœ¬åœ°å­˜å‚¨åŠ è½½å¯¹è¯å†å²
      init() {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.CONVERSATIONS);
        if (saved) {
          try {
            this.conversations = JSON.parse(saved);
          } catch (e) {
            console.warn('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', e);
            this.conversations = {
              interaction: [],
              lottery: [],
              question: [],
              promotion: []
            };
          }
        }
      },
      
      // ä¿å­˜å¯¹è¯å†å²åˆ°æœ¬åœ°å­˜å‚¨
      save() {
        localStorage.setItem(CONFIG.STORAGE_KEYS.CONVERSATIONS, JSON.stringify(this.conversations));
      },
      
      // è·å–åˆ†ç±»çš„å¯¹è¯å†å²
      getConversation(category) {
        return this.conversations[category] || [];
      },
      
      // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯å†å²
      addMessage(category, role, content) {
        if (!this.conversations[category]) {
          this.conversations[category] = [];
        }
        this.conversations[category].push({ role, content });
        
        // é™åˆ¶å¯¹è¯å†å²é•¿åº¦ï¼Œä¿ç•™æœ€è¿‘10è½®å¯¹è¯
        if (this.conversations[category].length > 20) {
          this.conversations[category] = this.conversations[category].slice(-20);
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        this.save();
      },
      
      // æ¸…ç©ºæ‰€æœ‰å¯¹è¯å†å²
      clearAllConversations() {
        this.conversations = {
          interaction: [],
          lottery: [],
          question: [],
          promotion: []
        };
        this.save();
      },
      
      // æ¸…ç©ºæŒ‡å®šåˆ†ç±»çš„å¯¹è¯å†å²
      clearConversation(category) {
        this.conversations[category] = [];
        this.save();
      }
    };

    // AIç›¸å…³åŠŸèƒ½
    const aiService = {
      // è°ƒç”¨AI APIï¼ˆæ”¯æŒå¯¹è¯ä¸Šä¸‹æ–‡ï¼‰
      async callAI(prompt, content, category = null, isRefresh = false) {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const modelName = document.getElementById('modelName').value;
        
        let messages = [];
        
        if (category && isRefresh) {
          // åˆ·æ–°æ¨¡å¼ï¼šåŸºäºä¸Šä¸€è½®å¯¹è¯
          const conversation = conversationManager.getConversation(category);
          messages = [...conversation];
          
          // æ·»åŠ åˆ·æ–°è¯·æ±‚
          const categoryNames = {
            interaction: 'è¯„è®ºåŒºäº’åŠ¨è¯æœ¯',
            lottery: 'æŠ½å¥–è¯æœ¯', 
            question: 'äº’åŠ¨é—®é¢˜',
            promotion: 'æœ‹å‹åœˆè½¬å‘è¯æœ¯'
          };
          
          const refreshPrompt = `è¯·åŸºäºæˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œå†ä¸ºæˆ‘ç”Ÿæˆä¸€äº›æ–°çš„${categoryNames[category]}ï¼Œè¦æ±‚ï¼š
1. ä¸ä¹‹å‰ç”Ÿæˆçš„å†…å®¹ä¸é‡å¤
2. ä¿æŒç›¸åŒçš„é£æ ¼å’Œè´¨é‡
3. æ•°é‡ä¸ä¹‹å‰ç›¸åŒ
4. è¯·æŒ‰ç…§ä¹‹å‰çº¦å®šçš„æ ¼å¼è¾“å‡ºï¼ˆæ•°å­—åºå· + å†…å®¹ï¼‰`;
          
          messages.push({ role: 'user', content: refreshPrompt });
        } else {
          // é¦–æ¬¡åˆ†ææ¨¡å¼
          const fullPrompt = prompt.replace('{content}', content);
          messages = [{ role: 'user', content: fullPrompt }];
        }
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: modelName,
            messages: messages,
            temperature: 0.7,
            max_tokens: 2000
          })
        });
        
        if (!response.ok) {
          throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const result = data.choices[0].message.content;
        
        // ä¿å­˜å¯¹è¯å†å²
        if (category) {
          if (isRefresh) {
            // åˆ·æ–°æ¨¡å¼ï¼šæ·»åŠ åˆ·æ–°è¯·æ±‚å’Œå›å¤
            const lastUserMessage = messages[messages.length - 1];
            conversationManager.addMessage(category, 'user', lastUserMessage.content);
          } else {
            // é¦–æ¬¡åˆ†æï¼šæ·»åŠ å®Œæ•´çš„æç¤ºè¯å’Œå›å¤
            const fullPrompt = prompt.replace('{content}', content);
            conversationManager.addMessage(category, 'user', fullPrompt);
          }
          conversationManager.addMessage(category, 'assistant', result);
        }
        
        return result;
      },

      // è·å–æç¤ºè¯
      getPrompt(category) {
        const savedPrompts = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.CUSTOM_PROMPTS) || '{}');
        return savedPrompts[category] || CONFIG.DEFAULT_PROMPTS[category];
      }
    };

    // è¯æœ¯ç®¡ç†
    const scriptManager = {
      // æ›´æ–°è¯æœ¯å¡ç‰‡
      updateScriptCards(results) {
        const categories = Object.keys(CONFIG.CATEGORIES);
        categories.forEach((category, index) => {
          if (results[index]) {
            this.updateCategoryCards(category, utils.parseAIResult(results[index]));
          }
        });
        // ä¿å­˜ç”Ÿæˆçš„è¯æœ¯åˆ°æœ¬åœ°å­˜å‚¨
        this.saveScriptsToLocal();
      },

      // æ›´æ–°æŒ‡å®šåˆ†ç±»çš„å¡ç‰‡
      updateCategoryCards(category, scripts) {
        // æ ¹æ®åˆ†ç±»é€‰æ‹©æ­£ç¡®çš„å®¹å™¨
        const container = category === 'question' 
          ? document.getElementById('questionsGrid')
          : document.getElementById('scriptsGrid');
        
        // åˆ é™¤è¯¥åˆ†ç±»çš„ç°æœ‰å¡ç‰‡
        const existingCards = container.querySelectorAll(`[data-category="${category}"]`);
        existingCards.forEach(card => card.remove());
        
        // å¦‚æœå®¹å™¨ä¸­æ²¡æœ‰å…¶ä»–å†…å®¹ï¼Œå…ˆæ¸…ç©ºé»˜è®¤æç¤ºæ–‡æœ¬
        if (container.children.length === 1 && container.children[0].tagName === 'P') {
          container.innerHTML = '';
        }
        
        // æ·»åŠ æ–°å¡ç‰‡
        scripts.forEach((script, index) => {
          const card = this.createScriptCard(category, script, index + 1);
          container.appendChild(card);
        });
        
        // ä¿å­˜è¯æœ¯åˆ°æœ¬åœ°å­˜å‚¨
        this.saveScriptsToLocal();
      },

      // åˆ›å»ºè¯æœ¯å¡ç‰‡
      createScriptCard(category, content, index) {
        const card = document.createElement('div');
        card.className = `script-card ${category}`;
        card.dataset.category = category;
        
        // åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
        const header = document.createElement('div');
        header.className = 'script-header';
        
        // åˆ›å»ºæ ‡é¢˜
        const title = document.createElement('div');
        title.className = 'script-title';
        title.textContent = `${utils.getCategoryName(category)} ${index}`;
        
        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'ğŸ“‹ å¤åˆ¶';
        copyBtn.onclick = () => utils.copyToClipboard(content);
        
        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const contentDiv = document.createElement('div');
        contentDiv.className = 'script-content';
        contentDiv.textContent = content;
        
        // ç»„è£…å¡ç‰‡
        header.appendChild(title);
        header.appendChild(copyBtn);
        card.appendChild(header);
        card.appendChild(contentDiv);
        
        return card;
      },



      // è¿‡æ»¤è¯æœ¯
      filterScripts(category) {
        const cards = document.querySelectorAll('.script-card');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const scriptsGrid = document.getElementById('scriptsGrid');
        const questionsGrid = document.getElementById('questionsGrid');
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        filterBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.category === category);
        });
        
        // æ˜¾ç¤º/éšè—å¡ç‰‡å’Œå®¹å™¨
        if (category === 'all') {
          // æ˜¾ç¤ºæ‰€æœ‰
          cards.forEach(card => card.style.display = 'block');
          scriptsGrid.style.display = 'grid';
          questionsGrid.style.display = 'grid';
        } else if (category === 'question') {
          // åªæ˜¾ç¤ºé—®é¢˜
          cards.forEach(card => {
            card.style.display = card.dataset.category === 'question' ? 'block' : 'none';
          });
          scriptsGrid.style.display = 'none';
          questionsGrid.style.display = 'grid';
        } else {
          // æ˜¾ç¤ºå…¶ä»–åˆ†ç±»
          cards.forEach(card => {
            card.style.display = card.dataset.category === category ? 'block' : 'none';
          });
          scriptsGrid.style.display = 'grid';
          questionsGrid.style.display = 'none';
        }
      },

      // æ¸…ç©ºæ‰€æœ‰è¯æœ¯
      clearAllScripts() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¯æœ¯å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶æ¸…é™¤å¯¹è¯ä¸Šä¸‹æ–‡å’Œæœ¬åœ°ä¿å­˜çš„è¯æœ¯ï¼Œä¸å¯æ¢å¤ï¼')) {
          const scriptsGrid = document.getElementById('scriptsGrid');
          const questionsGrid = document.getElementById('questionsGrid');
          
          scriptsGrid.innerHTML = '<p style="text-align: center; color: #666; margin: 50px 0;">æš‚æ— è¯æœ¯å†…å®¹ï¼Œè¯·ä½¿ç”¨AIåˆ†æåŠŸèƒ½ç”Ÿæˆè¯æœ¯</p>';
          questionsGrid.innerHTML = '<p style="text-align: center; color: #666; margin: 50px 0;">æš‚æ— é—®é¢˜å†…å®¹ï¼Œè¯·ä½¿ç”¨AIåˆ†æåŠŸèƒ½ç”Ÿæˆé—®é¢˜</p>';
          
          // æ¸…ç©ºæ‰€æœ‰å¯¹è¯ä¸Šä¸‹æ–‡
          conversationManager.clearAllConversations();
          
          // æ¸…ç©ºæœ¬åœ°ä¿å­˜çš„è¯æœ¯
          localStorage.removeItem(CONFIG.STORAGE_KEYS.GENERATED_SCRIPTS);
          
          utils.showToast('æ‰€æœ‰è¯æœ¯ã€é—®é¢˜ã€å¯¹è¯ä¸Šä¸‹æ–‡å’Œæœ¬åœ°ä¿å­˜çš„è¯æœ¯å·²æ¸…ç©ºï¼');
        }
      },
      
      // ä¿å­˜è¯æœ¯åˆ°æœ¬åœ°å­˜å‚¨
      saveScriptsToLocal() {
        const scriptsData = {};
        const categories = Object.keys(CONFIG.CATEGORIES);
        
        categories.forEach(category => {
          const cards = document.querySelectorAll(`[data-category="${category}"]`);
          scriptsData[category] = Array.from(cards).map(card => {
            const contentElement = card.querySelector('.script-content');
            return contentElement ? contentElement.textContent : '';
          });
        });
        
        localStorage.setItem(CONFIG.STORAGE_KEYS.GENERATED_SCRIPTS, JSON.stringify(scriptsData));
      },
      
      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è¯æœ¯
      loadScriptsFromLocal() {
        const savedScripts = localStorage.getItem(CONFIG.STORAGE_KEYS.GENERATED_SCRIPTS);
        if (!savedScripts) return;
        
        try {
          const scriptsData = JSON.parse(savedScripts);
          const categories = Object.keys(CONFIG.CATEGORIES);
          
          categories.forEach(category => {
            if (scriptsData[category] && scriptsData[category].length > 0) {
              this.updateCategoryCards(category, scriptsData[category]);
            }
          });
          
          // å¦‚æœæœ‰ä¿å­˜çš„è¯æœ¯ï¼Œæ˜¾ç¤ºæç¤º
          const totalScripts = categories.reduce((total, category) => {
            return total + (scriptsData[category] ? scriptsData[category].length : 0);
          }, 0);
          
          if (totalScripts > 0) {
            utils.showToast(`å·²æ¢å¤ ${totalScripts} æ¡æœ¬åœ°ä¿å­˜çš„è¯æœ¯ï¼`);
          }
        } catch (error) {
          console.error('åŠ è½½æœ¬åœ°è¯æœ¯å¤±è´¥:', error);
          // å¦‚æœæ•°æ®æŸåï¼Œæ¸…é™¤æ— æ•ˆæ•°æ®
          localStorage.removeItem(CONFIG.STORAGE_KEYS.GENERATED_SCRIPTS);
        }
      }
    };

    // é…ç½®ç®¡ç†
    const configManager = {
      // ä¿å­˜é…ç½®
      saveConfig() {
        const modelSelect = document.getElementById('modelSelect');
        const modelName = document.getElementById('modelName');
        const finalModelName = modelSelect.value === 'custom' ? modelName.value : modelSelect.value;
        
        const config = {
          apiUrl: document.getElementById('apiUrl').value,
          apiKey: document.getElementById('apiKey').value,
          modelName: finalModelName,
          modelSelectValue: modelSelect.value
        };
        localStorage.setItem(CONFIG.STORAGE_KEYS.AI_CONFIG, JSON.stringify(config));
        utils.showToast('é…ç½®å·²ä¿å­˜ï¼');
      },

      // åŠ è½½é…ç½®
      loadConfig() {
        const config = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.AI_CONFIG) || '{}');
        if (config.apiUrl) document.getElementById('apiUrl').value = config.apiUrl;
        if (config.apiKey) document.getElementById('apiKey').value = config.apiKey;
        
        const modelSelect = document.getElementById('modelSelect');
        const modelName = document.getElementById('modelName');
        
        if (config.modelSelectValue) {
          modelSelect.value = config.modelSelectValue;
          if (config.modelSelectValue === 'custom') {
            modelName.style.display = 'block';
            modelName.value = config.modelName || '';
          } else {
            modelName.style.display = 'none';
            modelName.value = config.modelSelectValue;
          }
        } else if (config.modelName) {
          // å…¼å®¹æ—§é…ç½®
          const predefinedModels = ['DeepSeek-R1', 'gemini-2.5-flash-preview-05-20', 'gemini-2.5-pro-preview-06-05'];
          if (predefinedModels.includes(config.modelName)) {
            modelSelect.value = config.modelName;
            modelName.style.display = 'none';
            modelName.value = config.modelName;
          } else {
            modelSelect.value = 'custom';
            modelName.style.display = 'block';
            modelName.value = config.modelName;
          }
        }
      },

      // ä¿å­˜æç¤ºè¯
      savePrompt() {
        const prompt = document.getElementById('currentPrompt').value;
        const savedPrompts = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.CUSTOM_PROMPTS) || '{}');
        savedPrompts[currentPromptType] = prompt;
        localStorage.setItem(CONFIG.STORAGE_KEYS.CUSTOM_PROMPTS, JSON.stringify(savedPrompts));
        utils.showToast('æç¤ºè¯å·²ä¿å­˜ï¼');
      },

      // é‡ç½®æç¤ºè¯
      resetPrompt() {
        document.getElementById('currentPrompt').value = CONFIG.DEFAULT_PROMPTS[currentPromptType];
        utils.showToast('æç¤ºè¯å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼');
      },

      // åŠ è½½å½“å‰æç¤ºè¯
      loadCurrentPrompt() {
        const savedPrompts = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.CUSTOM_PROMPTS) || '{}');
        const prompt = savedPrompts[currentPromptType] || CONFIG.DEFAULT_PROMPTS[currentPromptType];
        document.getElementById('currentPrompt').value = prompt;
      }
    };

    // å†å²è®°å½•ç®¡ç†
    const historyManager = {
      // ä¿å­˜åˆ°å†å²è®°å½•
      saveToHistory(script, results) {
        const historyItem = {
          id: Date.now(),
          date: new Date().toLocaleString(),
          script: script.substring(0, 100) + (script.length > 100 ? '...' : ''),
          results: results
        };
        
        analysisHistory.unshift(historyItem);
        
        // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
        if (analysisHistory.length > 20) {
          analysisHistory = analysisHistory.slice(0, 20);
        }
        
        localStorage.setItem(CONFIG.STORAGE_KEYS.ANALYSIS_HISTORY, JSON.stringify(analysisHistory));
        this.loadHistory();
      },

      // åŠ è½½å†å²è®°å½•
      loadHistory() {
        const historyList = document.getElementById('historyList');
        
        if (analysisHistory.length === 0) {
          historyList.innerHTML = '<p class="no-history">æš‚æ— åˆ†æå†å²</p>';
          return;
        }
        
        historyList.innerHTML = analysisHistory.map(item => `
          <div class="history-item" onclick="historyManager.loadHistoryItem(${item.id})">
            <div class="history-item-date">${item.date}</div>
            <div class="history-item-preview">${item.script}</div>
          </div>
        `).join('');
      },

      // åŠ è½½å†å²è®°å½•é¡¹
      loadHistoryItem(id) {
        const item = analysisHistory.find(h => h.id === id);
        if (item) {
          scriptManager.updateScriptCards(item.results);
          toggleAIPanel();
          utils.showToast('å·²åŠ è½½å†å²åˆ†æç»“æœï¼');
        }
      },

      // æ¸…ç©ºå†å²è®°å½•
      clearHistory() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åˆ†æå†å²å—ï¼Ÿ')) {
          analysisHistory = [];
          localStorage.removeItem(CONFIG.STORAGE_KEYS.ANALYSIS_HISTORY);
          this.loadHistory();
          utils.showToast('å†å²è®°å½•å·²æ¸…ç©ºï¼');
        }
      }
    };

    // å…¨å±€å˜é‡å­˜å‚¨åˆ†æçŠ¶æ€
     let analysisState = {
       isRunning: false,
       results: [],
       currentCategory: 0,
       liveScript: ''
     };

     // æ›´æ–°è¿›åº¦æ¡
     function updateProgress(current, total, message) {
       const progressBar = document.getElementById('progressBar');
       const progressText = document.getElementById('progressText');
       const progressPercent = document.getElementById('progressPercent');
       const progressDetails = document.getElementById('progressDetails');
       
       const percent = Math.round((current / total) * 100);
       progressBar.style.width = percent + '%';
       progressPercent.textContent = percent + '%';
       progressText.textContent = message;
       progressDetails.textContent = `å·²å®Œæˆ ${current}/${total} ä¸ªåˆ†æä»»åŠ¡`;
     }

     // é‡ç½®åˆ†æUI
     function resetAnalysisUI() {
       const analyzeBtn = document.getElementById('analyzeBtn');
       const progressContainer = document.getElementById('progressContainer');
       const returnBtn = document.getElementById('returnBtn');
       
       analyzeBtn.style.display = 'block';
       progressContainer.style.display = 'none';
       returnBtn.style.display = 'none';
       
       analysisState.isRunning = false;
     }

     // è¿”å›ä¸»é¡µï¼ˆåå°ç»§ç»­ç”Ÿæˆï¼‰
     function returnToHome() {
       toggleAIPanel();
       utils.showToast('å·²è¿”å›ä¸»é¡µï¼ŒAIå°†åœ¨åå°ç»§ç»­ç”Ÿæˆè¯æœ¯');
     }

     // AIåˆ†æå‡½æ•°ï¼ˆä¸²è¡Œå¤„ç†ï¼‰
    async function analyzeScript() {
      if (!utils.validateConfig()) return;
      
      const liveScript = document.getElementById('liveScript').value.trim();
      if (!liveScript) {
        utils.showToast('è¯·å…ˆè¾“å…¥ç›´æ’­ç¨¿å†…å®¹', 'error');
        return;
      }
      
      // åˆå§‹åŒ–åˆ†æçŠ¶æ€
      analysisState = {
        isRunning: true,
        results: [],
        currentCategory: 0,
        liveScript: liveScript
      };
      
      const analyzeBtn = document.getElementById('analyzeBtn');
      const btnText = analyzeBtn.querySelector('.btn-text');
      const spinner = analyzeBtn.querySelector('.loading-spinner');
      const progressContainer = document.getElementById('progressContainer');
      const returnBtn = document.getElementById('returnBtn');
      
      // æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œéšè—æŒ‰é’®
      analyzeBtn.style.display = 'none';
      progressContainer.style.display = 'block';
      returnBtn.style.display = 'block';
      
      try {
        // æ¸…ç©ºæ‰€æœ‰å¯¹è¯å†å²ï¼Œé‡æ–°å¼€å§‹
        conversationManager.clearAllConversations();
        
        // ä¸²è¡Œè°ƒç”¨å››ä¸ªåˆ†æä»»åŠ¡
        const categories = Object.keys(CONFIG.CATEGORIES);
        const categoryNames = {
          interaction: 'ğŸ’¬ è¯„è®ºåŒºäº’åŠ¨è¯æœ¯',
          lottery: 'ğŸ æŠ½å¥–è¯æœ¯',
          question: 'â“ äº’åŠ¨é—®é¢˜',
          promotion: 'ğŸ“¢ æœ‹å‹åœˆè½¬å‘è¯æœ¯'
        };
        
        for (let i = 0; i < categories.length; i++) {
          if (!analysisState.isRunning) break; // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
          
          const category = categories[i];
          analysisState.currentCategory = i;
          
          // æ›´æ–°è¿›åº¦
          updateProgress(i, categories.length, `æ­£åœ¨ç”Ÿæˆ${categoryNames[category]}...`);
          
          try {
            const result = await aiService.callAI(
              aiService.getPrompt(category), 
              liveScript, 
              category, 
              false
            );
            
            analysisState.results[i] = result;
            
            // å®æ—¶æ›´æ–°é¡µé¢ï¼ˆå•ä¸ªåˆ†ç±»å®Œæˆæ—¶ï¼‰
            const scripts = utils.parseAIResult(result);
            scriptManager.updateCategoryCards(category, scripts);
            
            // æ˜¾ç¤ºå®Œæˆæç¤º
            updateProgress(i + 1, categories.length, `${categoryNames[category]} ç”Ÿæˆå®Œæˆï¼`);
            
          } catch (error) {
            console.error(`${category} åˆ†æå¤±è´¥:`, error);
            analysisState.results[i] = null;
            updateProgress(i + 1, categories.length, `${categoryNames[category]} ç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª...`);
          }
        }
        
        // åˆ†æå®Œæˆ
        if (analysisState.isRunning) {
          // ä¿å­˜åˆ°å†å²è®°å½•
          const validResults = analysisState.results.filter(r => r !== null);
          if (validResults.length > 0) {
            historyManager.saveToHistory(liveScript, analysisState.results);
          }
          
          updateProgress(categories.length, categories.length, 'ğŸ‰ æ‰€æœ‰è¯æœ¯ç”Ÿæˆå®Œæˆï¼');
          
          setTimeout(() => {
            resetAnalysisUI();
            utils.showToast('AIåˆ†æå®Œæˆï¼è¯æœ¯å·²æ›´æ–°åˆ°é¡µé¢ä¸­');
          }, 2000);
        }
        
      } catch (error) {
        console.error('åˆ†æå¤±è´¥:', error);
        utils.showToast('åˆ†æå¤±è´¥ï¼š' + error.message, 'error');
        resetAnalysisUI();
      }
    }

    async function refreshCategory(category) {
      if (!utils.validateConfig()) return;
      
      const liveScript = document.getElementById('liveScript').value.trim();
      const refreshBtn = document.querySelector(`[data-category="${category}"].refresh-btn`);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹è¯å†å²
      const conversation = conversationManager.getConversation(category);
      if (conversation.length === 0) {
        utils.showToast('è¯·å…ˆè¿›è¡ŒAIåˆ†æï¼Œå†ä½¿ç”¨åˆ·æ–°åŠŸèƒ½', 'error');
        return;
      }
      
      utils.setButtonLoading(refreshBtn, true);
      
      try {
        // ä½¿ç”¨åˆ·æ–°æ¨¡å¼è°ƒç”¨AIï¼ŒåŸºäºä¸Šä¸€è½®å¯¹è¯
        const result = await aiService.callAI(aiService.getPrompt(category), liveScript, category, true);
        const scripts = utils.parseAIResult(result);
        scriptManager.updateCategoryCards(category, scripts);
        
        const categoryName = utils.getCategoryName(category).replace(/[ğŸ’¬ğŸâ“ğŸ“¢]/g, '').trim();
        utils.showToast(`${categoryName}è¯æœ¯å·²åˆ·æ–°ï¼`);
        
      } catch (error) {
        console.error('åˆ·æ–°å¤±è´¥:', error);
        utils.showToast('åˆ·æ–°å¤±è´¥ï¼š' + error.message, 'error');
      } finally {
        utils.setButtonLoading(refreshBtn, false);
      }
    }

    function toggleAIPanel() {
      const panel = document.getElementById('aiPanel');
      panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
    }

    function switchPromptTab(type) {
      currentPromptType = type;
      
      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.prompt-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.includes(utils.getCategoryName(type)));
      });
      
      // åŠ è½½å¯¹åº”æç¤ºè¯
      configManager.loadCurrentPrompt();
    }



    // äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–å¯¹è¯ç®¡ç†å™¨
      conversationManager.init();
      
      // åŠ è½½é…ç½®
      configManager.loadConfig();
      configManager.loadCurrentPrompt();
      historyManager.loadHistory();
      
      // åŠ è½½æœ¬åœ°ä¿å­˜çš„è¯æœ¯
      scriptManager.loadScriptsFromLocal();
      
      // ç»‘å®šè¿‡æ»¤å™¨äº‹ä»¶
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          scriptManager.filterScripts(btn.dataset.category);
        });
      });
      
      // ç»‘å®šå¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
          analyzeScript();
        }
        if (e.key === 'Escape') {
          const panel = document.getElementById('aiPanel');
          if (panel.style.display !== 'none') {
            toggleAIPanel();
          }
        }
      });
    });

    // å¤„ç†æ¨¡å‹é€‰æ‹©
    function handleModelSelect() {
      const modelSelect = document.getElementById('modelSelect');
      const modelName = document.getElementById('modelName');
      
      if (modelSelect.value === 'custom') {
        modelName.style.display = 'block';
        modelName.focus();
      } else {
        modelName.style.display = 'none';
        modelName.value = modelSelect.value;
      }
    }

    // å…¨å±€å‡½æ•°ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    window.analyzeScript = analyzeScript;
    window.refreshCategory = refreshCategory;
    window.toggleAIPanel = toggleAIPanel;
    window.switchPromptTab = switchPromptTab;

    window.handleModelSelect = handleModelSelect;
    window.saveConfig = configManager.saveConfig;
    window.savePrompt = configManager.savePrompt;
    window.resetPrompt = configManager.resetPrompt;
    window.clearAllScripts = scriptManager.clearAllScripts;
    window.clearHistory = historyManager.clearHistory;
    window.returnToHome = returnToHome;
    window.updateProgress = updateProgress;
    window.resetAnalysisUI = resetAnalysisUI;
  </script>
</body>
</html>